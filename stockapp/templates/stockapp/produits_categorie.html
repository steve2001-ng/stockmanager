{% extends "stockapp/base.html" %}
{% load static %}

{% block title %}Produits - {{ categorie.nom }}{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ categorie.nom }}</h1>
    <p class="subtitle">{{ categorie.description }}</p>

    <div class="category-actions mb-3">
        <a href="{% url 'stockapp:creer_commande' categorie.id %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Nouvelle commande
        </a>
        <a href="{% url 'stockapp:historique_commandes' categorie.id %}" class="btn btn-secondary">
            <i class="fas fa-history"></i> Historique
        </a>
    </div>

    <div class="product-section">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="mb-0">Liste des Produits</h2>
            <button id="show-form-btn" type="button" class="btn btn-success">
                <i class="fas fa-plus-circle"></i> Créer un article
            </button>
        </div>

        <div class="search-bar-container">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="product-search" placeholder="Rechercher un produit...">
                <button id="reset-search" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Réinitialiser
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="product-table">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Famille</th>
                        <th>Désignation</th>
                        <th>Fournisseur</th>
                        <th>Caractéristiques</th>
                        <th>Qté en stock</th>
                        <th>Stock d'alerte</th>
                        <th>Statut</th>
                        <th>Image</th>
                        <th>Date modification</th>
                    </tr>
                </thead>
                <tbody>
                    {% for produit in produits %}
                    <tr data-product-id="{{ produit.id }}" class="product-row">
                        <td>{{ produit.code }}</td>
                        <td>{{ produit.famille }}</td>
                        <td>{{ produit.designation }}</td>
                        <td>{{ produit.fournisseur }}</td>
                        <td class="caracteristiques-cell">
                            {% if produit.caracteristiques %}
                                {{ produit.caracteristiques|linebreaksbr }}
                            {% else %}-{% endif %}
                        </td>
                        <td class="stock-cell stock-{{ produit.statut_stock }}">{{ produit.quantite }}</td>
                        <td>{{ produit.stock_alerte }}</td>
                        <td>
                            <span class="status-badge status-{{ produit.statut_stock }}">
                                {% if produit.statut_stock == "danger" %}ALERTE
                                {% elif produit.statut_stock == "warning" %}ATTENTION
                                {% else %}OK{% endif %}
                            </span>
                        </td>
                        <td>
                            {% if produit.image %}
                                <img src="{{ produit.image.url }}" alt="{{ produit.designation }}" class="product-thumbnail">
                            {% else %}
                                <span class="no-image">Aucune image</span>
                            {% endif %}
                        </td>
                        <td>{{ produit.date_maj|date:"d/m/Y H:i" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center">Aucun produit dans cette catégorie</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Boutons mouvements -->
    <div class="category-actions mt-4">
        <button type="button" class="btn btn-info" onclick="document.getElementById('mouvement-form').style.display='block';">
            <i class="fas fa-exchange-alt"></i> Nouveau mouvement
        </button>
        <a href="{% url 'stockapp:historique_mouvements' categorie.id %}" class="btn btn-outline-dark">
            <i class="fas fa-list"></i> Historique des mouvements
        </a>
    </div>

    <!-- Formulaire mouvement -->
    <div id="mouvement-form" class="add-product-form" style="display:none; margin-top:2rem;">
    <h2>Mouvement de stock</h2>
    <form method="post" id="mouvement-form-el">
        {% csrf_token %}
        <input type="hidden" name="enregistrer_mouvement" value="1">

        {# Le formulaire Django #}
        
        {# Nouvelle ligne pour afficher la quantité #}
        <div class="mb-3">
        <small>
            Quantité en stock actuelle : 
            <strong id="current-stock">—</strong>
        </small>
        </div>
        {{ mouvement_form.as_p }}
        {# Bloc d’erreur JS (restera vide tant que tout va bien) #}
        <div id="quantite-error" class="text-danger small mt-1"></div>
        {# Bloc d’erreur Django (si jamais la validation serveur renvoie une erreur) #}
        {% if mouvement_form.quantite.errors %}
            <div class="text-danger small">
            {{ mouvement_form.quantite.errors.0 }}
            </div>
        {% endif %}
        

        <button type="submit" class="btn btn-primary">Valider le mouvement</button>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('mouvement-form').style.display='none';">Annuler</button>
    </form>
    </div>


    <!-- Formulaire produit (MASQUÉ PAR DÉFAUT) -->
    <div id="product-form-wrapper" class="add-product-form" style="display:none;">
        <h2 id="form-title">Ajouter un nouvel article</h2>
        <form method="post" id="product-form" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="ajouter_produit" value="1">
            <input type="hidden" name="product_id" id="product_id" value="">
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name != 'image' %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {{ field }}
                        {{ field.errors }}
                    </div>
                    {% endif %}
                {% endfor %}
                <div class="form-group">
                    <label for="id_image">Image du produit</label>
                    {{ form.image }}
                    {{ form.image.errors }}
                    <small class="form-text text-muted">Format recommandé : 500x500 pixels</small>
                    <div id="image-preview" class="image-preview"></div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" id="submit-btn" class="btn btn-primary">Ajouter le produit</button>
                <button type="button" id="update-btn" class="btn btn-warning" style="display:none;">Modifier</button>
                <button type="button" id="delete-btn" class="btn btn-danger" style="display:none;">Supprimer</button>
                <button type="button" id="cancel-btn" class="btn btn-secondary">Annuler</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* Styles pour la sélection */
    .product-table tr.active {
        background-color: #e3f2fd !important;
        border-left: 3px solid #1e88e5;
    }
    
    /* Styles pour les boutons */
    .btn-warning {
        background-color: #ffc107;
        color: #212529;
    }
    
    .btn-danger {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    .form-actions {
        margin-top: 1.5rem;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    /* Animation pour les boutons */
    .btn {
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Styles pour les images */
    .product-thumbnail {
        width: 75px;
        height: 70px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    
    .no-image {
        color: #6c757d;
        font-size: 0.8rem;
    }
    
    /* Ajustement pour l'input file */
    .form-control[type="file"] {
        padding: 0.375rem;
    }
    
    /* Aperçu de l'image sélectionnée */
    .image-preview {
        margin-top: 10px;
        display: none;
    }
    
    .image-preview img {
        max-width: 150px;
        max-height: 150px;
        border-radius: 4px;
    }

    /* Style pour l'input file personnalisé */
    .form-control-file {
        display: block;
        width: 100%;
        padding: 0.375rem 0;
    }

    /* Style pour le preview d'image */
    #image-preview img {
        max-width: 100%;
        max-height: 200px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

     /* Style pour la cellule des caractéristiques */
     .caracteristiques-cell {
        max-width: 300px;
        white-space: pre-line;
        word-wrap: break-word;
    }
    
    /* Style pour le textarea */
    textarea.form-control {
        min-height: 120px;
        resize: vertical;
    }
    
    /* Style pour l'affichage multiligne */
    .multiline-text {
        white-space: pre-line;
    }

    /* Styles pour la barre de recherche */
    .search-bar-container {
        margin-bottom: 1.5rem;
    }
    
    .search-bar {
        display: flex;
        align-items: center;
        background: white;
        border-radius: 4px;
        padding: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .search-bar i {
        color: #6c757d;
        margin: 0 10px;
    }
    
    #product-search {
        flex-grow: 1;
        border: none;
        padding: 0.5rem;
        outline: none;
    }
    
    #reset-search {
        margin-left: 10px;
        padding: 0.5rem 1rem;
    }
    
    /* Style pour les lignes cachées */
    .product-table tr.hidden {
        display: none;
    }
</style>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const formWrapper = document.getElementById('product-form-wrapper');
    const showFormBtn = document.getElementById('show-form-btn');
    const form = document.getElementById('product-form');
    const submitBtn = document.getElementById('submit-btn');
    const updateBtn = document.getElementById('update-btn');
    const deleteBtn = document.getElementById('delete-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const productIdField = document.getElementById('product_id');
    const formTitle = document.getElementById('form-title');
    const rows = document.querySelectorAll('.product-row');

    function openForm() {
        formWrapper.style.display = 'block';
    }
    function closeForm() {
        formWrapper.style.display = 'none';
        resetForm();
    }
    function resetForm() {
        form.reset();
        productIdField.value = '';
        submitBtn.style.display = 'inline-block';
        updateBtn.style.display = 'none';
        deleteBtn.style.display = 'none';
        formTitle.textContent = 'Ajouter un nouvel article';
        document.querySelectorAll('.product-row').forEach(r => r.classList.remove('active'));
        document.getElementById('image-preview').innerHTML = '';
    }

    showFormBtn.addEventListener('click', function () {
        resetForm();
        openForm();
    });

    // Lorsqu'on clique sur une ligne → mode édition
    rows.forEach(row => {
        row.addEventListener('click', function () {
            openForm();
            rows.forEach(r => r.classList.remove('active'));
            this.classList.add('active');
            const cells = this.querySelectorAll('td');
            document.getElementById('id_code').value = cells[0].textContent.trim();
            document.getElementById('id_famille').value = cells[1].textContent.trim();
            document.getElementById('id_designation').value = cells[2].textContent.trim();
            document.getElementById('id_fournisseur').value = cells[3].textContent.trim();
            document.getElementById('id_caracteristiques').value = cells[4].textContent.trim();
            document.getElementById('id_quantite').value = cells[5].textContent.trim();
            document.getElementById('id_stock_alerte').value = cells[6].textContent.trim();
            // image
            const imagePreview = document.getElementById('image-preview');
            imagePreview.innerHTML = '';
            const img = cells[8].querySelector('img');
            if (img) {
                const clone = img.cloneNode(true);
                clone.style.width = '150px';
                imagePreview.appendChild(clone);
            }
            productIdField.value = this.dataset.productId;
            submitBtn.style.display = 'none';
            updateBtn.style.display = 'inline-block';
            deleteBtn.style.display = 'inline-block';
            formTitle.textContent = 'Modifier l’article';
        });
    });

    cancelBtn.addEventListener('click', function () {
        closeForm();
    });

    // Modifier
    updateBtn.addEventListener('click', function () {
        if (productIdField.value) {
            if (confirm('Confirmez-vous la modification de ce produit ?')) {
                form.action = "{% url 'stockapp:modifier_produit' 0 %}".replace('0', productIdField.value);
                form.submit();
            }
        }
    });

    // Supprimer
    deleteBtn.addEventListener('click', function () {
        if (productIdField.value) {
            if (confirm('Supprimer définitivement ce produit ?')) {
                window.location.href = "{% url 'stockapp:supprimer_produit' 0 %}".replace('0', productIdField.value);
            }
        }
    });

    // Recherche
    const searchInput = document.getElementById('product-search');
    const resetSearchBtn = document.getElementById('reset-search');
    searchInput.addEventListener('input', function () {
        const term = this.value.toLowerCase();
        rows.forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
    });
    resetSearchBtn.addEventListener('click', function () {
        searchInput.value = '';
        rows.forEach(r => r.style.display = '');
    });

    // Preview image à l'ajout
    document.getElementById('id_image').addEventListener('change', function (e) {
        const preview = document.getElementById('image-preview');
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = ev => {
                preview.innerHTML = `<img src="${ev.target.result}" alt="Aperçu" style="max-width:150px;">`;
            };
            reader.readAsDataURL(file);
        } else {
            preview.innerHTML = '';
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectProduit = document.getElementById('id_produit');  // Django génère l'id du champ "produit"
  const stockDisplay  = document.getElementById('current-stock');

  if (selectProduit && stockDisplay) {
    selectProduit.addEventListener('change', function() {
      const pid = this.value;
      if (!pid) {
        stockDisplay.textContent = '—';
        return;
      }
      fetch("{% url 'stockapp:produit_stock' 0 %}".replace('0', pid))
        .then(resp => resp.json())
        .then(data => {
          stockDisplay.textContent = data.quantite;
        })
        .catch(() => {
          stockDisplay.textContent = 'Erreur';
        });
    });

    // Optionnel : déclencher un premier chargement si une valeur est déjà sélectionnée
    selectProduit.dispatchEvent(new Event('change'));
  }
});

document.addEventListener('DOMContentLoaded', () => {
  const form   = document.getElementById('mouvement-form-el');
  const stock  = document.getElementById('current-stock');
  const qty    = document.getElementById('id_quantite');
  const errDiv = document.getElementById('quantite-error');

  form.addEventListener('submit', ev => {
    errDiv.textContent = '';       // on vide l’erreur JS
    const current = parseInt(stock.textContent, 10);
    const demande = parseInt(qty.value, 10);
    if (!isNaN(demande) && demande > current) {
      ev.preventDefault();
      errDiv.style.color = 'red';
      errDiv.textContent = `Vous ne pouvez pas sortir ${demande} ; il n'en reste que ${current}.`;
      qty.focus();
    }
  });
});
</script>
{% endblock %}


